;==============================================================================
; Spotify Now Playing - Rainmeter Skin
;==============================================================================
; A Rainmeter skin that displays currently playing track from Spotify using
; the Spotify Web API with OAuth 2.0 authentication.
;
; Requirements:
; - Valid Spotify account
; - Registered Spotify Developer App
; - OAuth credentials in @Vault\SpotifyCredentials.inc (run SpotifySetup.exe)
;
; Features:
; - Real-time track information (song, artist, album)
; - Album artwork with caching
; - Playback controls (play/pause, next, previous)
; - Progress bar with time display
; - Automatic token refresh (no manual intervention needed)
;
; Author: Spotify Rainmeter Skin Project
; Version: 1.0.0
; License: MIT
;==============================================================================

[Rainmeter]
Update=1000
BackgroundMode=2
SolidColor=0,0,0,200

;==============================================================================
; METADATA
;==============================================================================

[Metadata]
Name=Spotify Now Playing
Author=Spotify Rainmeter Skin Project
Version=1.0.0
License=MIT
Information=Displays currently playing Spotify track with playback controls

;==============================================================================
; VARIABLES
;==============================================================================

[Variables]
@Include=#@#..\@Vault\SpotifyCredentials.inc
@Include2=#@#Variables.inc

;==============================================================================
; MEASURES - TOKEN MANAGEMENT
;==============================================================================

; TokenManager Script - Handles automatic token refresh
[MeasureTokenManager]
Measure=Script
ScriptFile=#@#Scripts\TokenManager.lua
UpdateDivider=60
; Calls Initialize() on load, Update() every 60 seconds

;------------------------------------------------------------------------------
; Token Refresh WebParser - Requests new access token using refresh token
;------------------------------------------------------------------------------

[MeasureTokenRefresh]
Measure=WebParser
; Spotify Token Endpoint
URL=https://accounts.spotify.com/api/token
; POST request with refresh_token grant
RequestMethod=POST
; Basic authentication: Base64(client_id:client_secret)
Header=Authorization: Basic [MeasureAuthHeader]
Header2=Content-Type: application/x-www-form-urlencoded
; Request body
PostData=grant_type=refresh_token&refresh_token=#SpotifyRefreshToken#
; Parse JSON response
RegExp=(?siU)"access_token"\s*:\s*"(.+?)".+"expires_in"\s*:\s*([0-9]+).*("refresh_token"\s*:\s*"(.+?)")?
; Update only when triggered by TokenManager
UpdateRate=-1
; Callbacks
FinishAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshFinish()"]
OnConnectErrorAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshError('Connection failed')"]
OnRegExpErrorAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshError('Invalid response')"]
OnDownloadErrorAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshError('Download failed')"]

; Child measure - Access Token
[MeasureTokenRefreshAccessToken]
Measure=WebParser
URL=[MeasureTokenRefresh]
StringIndex=1
; Update skin variable for immediate use
FinishAction=[!SetVariable SpotifyAccessToken "[MeasureTokenRefreshAccessToken]"]

; Child measure - Expires In (seconds)
[MeasureTokenRefreshExpiresIn]
Measure=WebParser
URL=[MeasureTokenRefresh]
StringIndex=2

; Child measure - Refresh Token (optional - only returned if rotated)
[MeasureTokenRefreshRefreshToken]
Measure=WebParser
URL=[MeasureTokenRefresh]
StringIndex=4
; Update skin variable if present
FinishAction=[!SetVariable SpotifyRefreshToken "[&MeasureTokenRefreshRefreshToken:IfMatch(^$,0,1)]"]

;------------------------------------------------------------------------------
; Authorization Header Builder
; Encodes client_id:client_secret in Base64 for Basic auth
;------------------------------------------------------------------------------

; Note: Rainmeter doesn't have built-in Base64 encoding, so this needs to be
; pre-computed or done via Lua script. For simplicity, we'll create a helper measure.

[MeasureAuthHeader]
Measure=Script
ScriptFile=#@#Scripts\Base64Encoder.lua
UpdateDivider=-1
; This script will encode SpotifyClientID:SpotifyClientSecret

;==============================================================================
; MEASURES - SPOTIFY API (Currently Playing)
;==============================================================================

; Currently Playing WebParser - Fetches current playback state
[MeasureNowPlaying]
Measure=WebParser
; Spotify Get Currently Playing endpoint
URL=https://api.spotify.com/v1/me/player/currently-playing
; GET request with Bearer token authentication
Header=Authorization: Bearer #SpotifyAccessToken#
; Parse JSON response - track name, artists, album, album art, progress, duration, is_playing
RegExp=(?siU)"is_playing"\s*:\s*(true|false).*"progress_ms"\s*:\s*([0-9]+).*"item"\s*:\s*\{.*"name"\s*:\s*"(.+?)".*"artists"\s*:\s*\[.*"name"\s*:\s*"(.+?)".*"album"\s*:\s*\{.*"name"\s*:\s*"(.+?)".*"images"\s*:\s*\[.*"url"\s*:\s*"(.+?)".*"duration_ms"\s*:\s*([0-9]+)
; Update every 5 seconds
UpdateRate=5
; Error handling
OnConnectErrorAction=[!SetOption MeterTrackName Text "Not Playing"][!UpdateMeter MeterTrackName][!Redraw]
OnRegExpErrorAction=[!SetOption MeterTrackName Text "No Track Info"][!UpdateMeter MeterTrackName][!Redraw]
OnDownloadErrorAction=[!SetOption MeterTrackName Text "API Error"][!UpdateMeter MeterTrackName][!Redraw]

; Child measure - Is Playing (true/false)
[MeasureIsPlaying]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=1

; Child measure - Progress (milliseconds)
[MeasureProgress]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=2

; Child measure - Track Name
[MeasureTrackName]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=3
Substitute="&quot;":"\"","&amp;":"&"

; Child measure - Artist Name
[MeasureArtistName]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=4
Substitute="&quot;":"\"","&amp;":"&"

; Child measure - Album Name
[MeasureAlbumName]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=5
Substitute="&quot;":"\"","&amp;":"&"

; Child measure - Album Art URL
[MeasureAlbumArtURL]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=6

; Child measure - Duration (milliseconds)
[MeasureDuration]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=7

;==============================================================================
; MEASURES - ALBUM ART DOWNLOAD
;==============================================================================

; Album Art Downloader
[MeasureAlbumArt]
Measure=Plugin
Plugin=WebParser
URL=[MeasureAlbumArtURL]
Download=1
; Cache album art in @Resources\Cache\
DownloadFile=#@#Cache\[MeasureAlbumArtURL:EncodeURL].jpg
UpdateRate=10
; Only download if URL changed
IfMatch=^$
IfNotMatchAction=[!SetOption MeterAlbumArt ImageName "#@#Images\default-album.png"]

;==============================================================================
; MEASURES - PLAYBACK CONTROLS
;==============================================================================

; Play/Resume Control
[MeasurePlayPause]
Measure=WebParser
URL=https://api.spotify.com/v1/me/player/play
RequestMethod=PUT
Header=Authorization: Bearer #SpotifyAccessToken#
UpdateRate=-1

; Pause Control
[MeasurePause]
Measure=WebParser
URL=https://api.spotify.com/v1/me/player/pause
RequestMethod=PUT
Header=Authorization: Bearer #SpotifyAccessToken#
UpdateRate=-1

; Next Track Control
[MeasureNext]
Measure=WebParser
URL=https://api.spotify.com/v1/me/player/next
RequestMethod=POST
Header=Authorization: Bearer #SpotifyAccessToken#
UpdateRate=-1
FinishAction=[!Delay 500][!CommandMeasure MeasureNowPlaying "Update"]

; Previous Track Control
[MeasurePrevious]
Measure=WebParser
URL=https://api.spotify.com/v1/me/player/previous
RequestMethod=POST
Header=Authorization: Bearer #SpotifyAccessToken#
UpdateRate=-1
FinishAction=[!Delay 500][!CommandMeasure MeasureNowPlaying "Update"]

;==============================================================================
; MEASURES - CALCULATED VALUES
;==============================================================================

; Progress Percentage (for progress bar)
[MeasureProgressPercent]
Measure=Calc
Formula=(MeasureProgress / MeasureDuration) * 100
MinValue=0
MaxValue=100

; Progress Time (formatted as MM:SS)
[MeasureProgressTime]
Measure=Calc
Formula=MeasureProgress / 1000
DynamicVariables=1

; Duration Time (formatted as MM:SS)
[MeasureDurationTime]
Measure=Calc
Formula=MeasureDuration / 1000
DynamicVariables=1

;==============================================================================
; METERS - UI LAYOUT
;==============================================================================

; Background
[MeterBackground]
Meter=Shape
X=0
Y=0
Shape=Rectangle 0,0,400,250,8 | Fill Color 20,20,20,230 | StrokeWidth 2 | Stroke Color 29,185,84,255

; Album Art Container
[MeterAlbumArtContainer]
Meter=Image
X=10
Y=10
W=150
H=150
ImageName=#@#Cache\current-album.jpg
PreserveAspectRatio=1
DynamicVariables=1

; Track Name
[MeterTrackName]
Meter=String
MeasureName=MeasureTrackName
X=170
Y=20
W=220
H=30
FontFace=Segoe UI
FontSize=14
FontWeight=600
FontColor=255,255,255,255
ClipString=1
DynamicVariables=1
Text=%1

; Artist Name
[MeterArtistName]
Meter=String
MeasureName=MeasureArtistName
X=170
Y=55
W=220
H=25
FontFace=Segoe UI
FontSize=11
FontColor=180,180,180,255
ClipString=1
DynamicVariables=1
Text=%1

; Album Name
[MeterAlbumName]
Meter=String
MeasureName=MeasureAlbumName
X=170
Y=80
W=220
H=25
FontFace=Segoe UI
FontSize=10
FontColor=150,150,150,255
ClipString=1
DynamicVariables=1
Text=%1

; Progress Bar Background
[MeterProgressBarBG]
Meter=Shape
X=170
Y=120
Shape=Rectangle 0,0,220,6,3 | Fill Color 60,60,60,255 | StrokeWidth 0

; Progress Bar Fill
[MeterProgressBar]
Meter=Shape
X=170
Y=120
Shape=Rectangle 0,0,(220 * [MeasureProgressPercent] / 100),6,3 | Fill Color 29,185,84,255 | StrokeWidth 0
DynamicVariables=1

; Progress Time Text
[MeterProgressTime]
Meter=String
MeasureName=MeasureProgressTime
X=170
Y=130
FontFace=Segoe UI
FontSize=9
FontColor=150,150,150,255
NumOfDecimals=0
AutoScale=1
Text=[MeasureProgressTime:FormatTime("%M:%S")]
DynamicVariables=1

; Duration Time Text
[MeterDurationTime]
Meter=String
MeasureName=MeasureDurationTime
X=385
Y=130
FontFace=Segoe UI
FontSize=9
FontColor=150,150,150,255
StringAlign=Right
NumOfDecimals=0
AutoScale=1
Text=[MeasureDurationTime:FormatTime("%M:%S")]
DynamicVariables=1

;==============================================================================
; METERS - PLAYBACK CONTROLS
;==============================================================================

; Previous Button
[MeterButtonPrevious]
Meter=Image
X=220
Y=170
W=32
H=32
ImageName=#@#Images\previous.png
LeftMouseUpAction=[!CommandMeasure MeasurePrevious "Update"]

; Play/Pause Button
[MeterButtonPlayPause]
Meter=Image
X=10R
Y=170
W=32
H=32
ImageName=#@#Images\[&MeasureIsPlaying:IfMatch(true,#@#Images\pause.png,#@#Images\play.png)]
LeftMouseUpAction=[!CommandMeasure MeasurePlayPause "Update"][[&MeasureIsPlaying:IfMatch(true,!CommandMeasure MeasurePause "Update",!CommandMeasure MeasurePlayPause "Update")]]
DynamicVariables=1

; Next Button
[MeterButtonNext]
Meter=Image
X=10R
Y=170
W=32
H=32
ImageName=#@#Images\next.png
LeftMouseUpAction=[!CommandMeasure MeasureNext "Update"]

;==============================================================================
; DEBUG METERS (Optional - comment out for production)
;==============================================================================

; Token Status
[MeterTokenStatus]
Meter=String
X=10
Y=220
FontFace=Consolas
FontSize=8
FontColor=100,100,100,255
Text=Token: [&MeasureTokenManager:GetStatus()] | Expires: [&MeasureTokenManager:GetTimeRemainingString()]
DynamicVariables=1
