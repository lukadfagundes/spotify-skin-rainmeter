;==============================================================================
; Spotify Now Playing - Rainmeter Skin
;==============================================================================
; A Rainmeter skin that displays currently playing track from Spotify using
; the Spotify Web API with OAuth 2.0 authentication.
;
; Requirements:
; - Valid Spotify account
; - Registered Spotify Developer App
; - OAuth credentials in @Vault\SpotifyCredentials.inc (run SpotifySetup.exe)
;
; Features:
; - Real-time track information (song, artist, album)
; - Album artwork with caching
; - Playback controls (play/pause, next, previous)
; - Progress bar with time display
; - Automatic token refresh (no manual intervention needed)
;
; Author: Spotify Rainmeter Skin Project
; Version: 1.0.0
; License: MIT
;==============================================================================

[Rainmeter]
Update=1000
BackgroundMode=2
SolidColor=0,0,0,200

;==============================================================================
; METADATA
;==============================================================================

[Metadata]
Name=Spotify Now Playing
Author=Spotify Rainmeter Skin Project
Version=1.0.0
License=MIT
Information=Displays currently playing Spotify track with playback controls

;==============================================================================
; VARIABLES
;==============================================================================

[Variables]
@Include=#SKINSPATH#@Vault\SpotifyCredentials.inc
@Include2=#@#Variables.inc

;==============================================================================
; MEASURES - TOKEN MANAGEMENT
;==============================================================================

; TokenManager Script - Handles automatic token refresh
[MeasureTokenManager]
Measure=Script
ScriptFile=#@#Scripts\TokenManager.lua
UpdateDivider=60
; Calls Initialize() on load, Update() every 60 seconds
OnUpdateAction=[!Log "TokenManager: Update() called, Status=[&MeasureTokenManager:GetStatus()], TimeRemaining=[&MeasureTokenManager:GetTimeRemainingString()]" Debug]

;------------------------------------------------------------------------------
; Authorization Header Builder
; Encodes client_id:client_secret in Base64 for Basic auth
;------------------------------------------------------------------------------

; Note: Rainmeter doesn't have built-in Base64 encoding, so this needs to be
; pre-computed or done via Lua script. This measure must run BEFORE MeasureTokenRefresh.

[MeasureAuthHeader]
Measure=Script
ScriptFile=#@#Scripts\Base64Encoder.lua
; This script will encode SpotifyClientID:SpotifyClientSecret and set AuthHeaderBase64 variable
FinishAction=[!Log "MeasureAuthHeader finished, AuthHeaderBase64=#AuthHeaderBase64#" Debug]
DynamicVariables=1

;------------------------------------------------------------------------------
; Token Refresh WebParser - Requests new access token using refresh token
;------------------------------------------------------------------------------

[MeasureTokenRefresh]
Measure=WebParser
; Spotify Token Endpoint
URL=https://accounts.spotify.com/api/token
; POST request with refresh_token grant
RequestMethod=POST
; Basic authentication: Base64(client_id:client_secret)
Header=Authorization: Basic #AuthHeaderBase64#
Header2=Content-Type: application/x-www-form-urlencoded
; Request body
PostData=grant_type=refresh_token&refresh_token=#SpotifyRefreshToken#
; Parse JSON response
RegExp=(?siU)"access_token"\s*:\s*"(.+?)".+"expires_in"\s*:\s*([0-9]+)..*("refresh_token"\s*:\s*"(.+?)")?
; Update only when triggered by TokenManager
UpdateRate=-1
DynamicVariables=1
Debug=0
; Log what we're sending
OnUpdateAction=[!Log "TokenRefresh: Base64=[#AuthHeaderBase64#]" Debug][!Log "TokenRefresh: RefreshToken=[#SpotifyRefreshToken#]" Debug]
; Callbacks
FinishAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshFinish()"]
OnConnectErrorAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshError('Connection failed')"]
OnRegExpErrorAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshError('Invalid response')"]
OnDownloadErrorAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshError('Download failed')"]

; Child measure - Access Token
[MeasureTokenRefreshAccessToken]
Measure=WebParser
URL=[MeasureTokenRefresh]
StringIndex=1
; Update skin variable for immediate use
FinishAction=[!SetVariable SpotifyAccessToken "[MeasureTokenRefreshAccessToken]"]

; Child measure - Expires In (seconds)
[MeasureTokenRefreshExpiresIn]
Measure=WebParser
URL=[MeasureTokenRefresh]
StringIndex=2

; Child measure - Refresh Token (optional - only returned if rotated)
[MeasureTokenRefreshRefreshToken]
Measure=WebParser
URL=[MeasureTokenRefresh]
StringIndex=4
; Update skin variable if present
FinishAction=[!SetVariable SpotifyRefreshToken "[&MeasureTokenRefreshRefreshToken:IfMatch(^$,0,1)]"]

;==============================================================================
; MEASURES - SPOTIFY API (Currently Playing)
;==============================================================================

; Currently Playing - Uses RunCommand to execute curl with dynamic Bearer token
; This approach works around WebParser's lack of DynamicVariables support for Headers
[MeasureNowPlayingData]
Measure=Plugin
Plugin=RunCommand
Program=curl
Parameter=-s -H "Authorization: Bearer #SpotifyAccessToken#" "https://api.spotify.com/v1/me/player/currently-playing"
OutputType=UTF8
State=Hide
DynamicVariables=1
FinishAction=[!Log "RunCommand: Curl completed, output length: [MeasureNowPlayingData]" Notice][!UpdateMeasure MeasureNowPlayingParser]

; Trigger - Calls RunCommand every 5 seconds to fetch now playing data
[MeasureTrigger]
Measure=Calc
Formula=Counter % 5
IfEqualValue=0
IfEqualAction=[!Log "Trigger: Executing curl..." Debug][!CommandMeasure MeasureNowPlayingData "Run"]

; Parser for RunCommand output - Parses the JSON response from curl
[MeasureNowPlayingParser]
Measure=String
String=[MeasureNowPlayingData]
RegExpSubstitute=1
; Extract JSON fields using regex
Substitute="":"QUOTE"
UpdateDivider=-1
FinishAction=[!Log "Parser: JSON response: [MeasureNowPlayingParser:~200]" Debug]

; Child measure - Track Name
[MeasureTrackName]
Measure=String
String=[MeasureNowPlayingData]
RegExpSubstitute=1
Substitute="(?siU).*\"item\"[^}]*\"name\"\s*:\s*\"([^\"]+)\".*":"\1"
OnChangeAction=[!Log "MeasureTrackName: Value changed to '[MeasureTrackName]'" Debug]

; Child measure - Artist Name
[MeasureArtistName]
Measure=String
String=[MeasureNowPlayingData]
RegExpSubstitute=1
Substitute="(?siU).*\"artists\"[^}]*\"name\"\s*:\s*\"([^\"]+)\".*":"\1"

; Child measure - Album Name
[MeasureAlbumName]
Measure=String
String=[MeasureNowPlayingData]
RegExpSubstitute=1
Substitute="(?siU).*\"album\"[^}]*\"name\"\s*:\s*\"([^\"]+)\".*":"\1"

; Child measure - Album Art URL
[MeasureAlbumArtURL]
Measure=String
String=[MeasureNowPlayingData]
RegExpSubstitute=1
Substitute="(?siU).*\"images\"[^}]*\"url\"\s*:\s*\"([^\"]+)\".*":"\1"

; Child measure - Duration (milliseconds)
[MeasureDuration]
Measure=String
String=[MeasureNowPlayingData]
RegExpSubstitute=1
Substitute="(?siU).*\"duration_ms\"\s*:\s*([0-9]+).*":"\1"

; Child measure - Progress (milliseconds)
[MeasureProgress]
Measure=String
String=[MeasureNowPlayingData]
RegExpSubstitute=1
Substitute="(?siU).*\"progress_ms\"\s*:\s*([0-9]+).*":"\1"

; Child measure - Is Playing (true/false)
[MeasureIsPlaying]
Measure=String
String=[MeasureNowPlayingData]
RegExpSubstitute=1
Substitute="(?siU).*\"is_playing\"\s*:\s*(true|false).*":"\1"

;==============================================================================
; MEASURES - ALBUM ART DOWNLOAD
;==============================================================================

; Album Art Downloader
[MeasureAlbumArt]
Measure=Plugin
Plugin=WebParser
URL=[MeasureAlbumArtURL]
Download=1
; Cache album art in @Resources\Cache\
DownloadFile=#@#Cache\current-album.jpg
UpdateRate=10
; When download completes, update the album art image
OnDownloadFinishAction=[!SetOption MeterAlbumArtContainer ImageName "#@#Cache\current-album.jpg"][!UpdateMeter MeterAlbumArtContainer][!Redraw]
; When URL is empty (no track playing), show default image
OnRegExpErrorAction=[!SetOption MeterAlbumArtContainer ImageName "#@#Images\default-album.png"][!UpdateMeter MeterAlbumArtContainer][!Redraw]

;==============================================================================
; MEASURES - PLAYBACK CONTROLS
;==============================================================================

; Play/Resume Control
[MeasurePlayPause]
Measure=WebParser
URL=https://api.spotify.com/v1/me/player/play
RequestMethod=PUT
UpdateRate=-1
Disabled=1

; Pause Control
[MeasurePause]
Measure=WebParser
URL=https://api.spotify.com/v1/me/player/pause
RequestMethod=PUT
UpdateRate=-1
Disabled=1

; Next Track Control
[MeasureNext]
Measure=WebParser
URL=https://api.spotify.com/v1/me/player/next
RequestMethod=POST
UpdateRate=-1
Disabled=1
FinishAction=[!Delay 500][!CommandMeasure MeasureSpotifyAPIController "Update"]

; Previous Track Control
[MeasurePrevious]
Measure=WebParser
URL=https://api.spotify.com/v1/me/player/previous
RequestMethod=POST
UpdateRate=-1
Disabled=1
FinishAction=[!Delay 500][!CommandMeasure MeasureSpotifyAPIController "Update"]

;==============================================================================
; MEASURES - CALCULATED VALUES
;==============================================================================

; Progress Percentage (for progress bar)
[MeasureProgressPercent]
Measure=Calc
Formula=Clamp((MeasureProgress / (MeasureDuration + 0.0001)) * 100, 0, 100)
MinValue=0
MaxValue=100

; Progress Time (formatted as MM:SS)
[MeasureProgressTime]
Measure=Calc
Formula=MeasureProgress / 1000
DynamicVariables=1

; Duration Time (formatted as MM:SS)
[MeasureDurationTime]
Measure=Calc
Formula=MeasureDuration / 1000
DynamicVariables=1

;==============================================================================
; METERS - UI LAYOUT
;==============================================================================

; Background
[MeterBackground]
Meter=Shape
X=0
Y=0
Shape=Rectangle 0,0,#SkinWidth#,#SkinHeight#,#SkinCornerRadius# | Fill Color #ColorBackground# | StrokeWidth 2 | Stroke Color #ColorBorder#

; Album Art Container
[MeterAlbumArtContainer]
Meter=Image
X=#AlbumArtX#
Y=#AlbumArtY#
W=#AlbumArtSize#
H=#AlbumArtSize#
ImageName=#@#Images\default-album.png
PreserveAspectRatio=1
DynamicVariables=1

; Track Name
[MeterTrackName]
Meter=String
MeasureName=MeasureTrackName
X=#TrackNameX#
Y=#TrackNameY#
W=#TrackNameW#
H=#TrackNameH#
FontFace=#FontFace#
FontSize=#FontSizeTrack#
FontWeight=#FontWeightTrack#
FontColor=#ColorTrackName#
ClipString=1
DynamicVariables=1

; Artist Name
[MeterArtistName]
Meter=String
MeasureName=MeasureArtistName
X=#ArtistNameX#
Y=#ArtistNameY#
W=#ArtistNameW#
H=#ArtistNameH#
FontFace=#FontFace#
FontSize=#FontSizeArtist#
FontColor=#ColorArtistName#
ClipString=1
DynamicVariables=1

; Album Name
[MeterAlbumName]
Meter=String
MeasureName=MeasureAlbumName
X=#AlbumNameX#
Y=#AlbumNameY#
W=#AlbumNameW#
H=#AlbumNameH#
FontFace=#FontFace#
FontSize=#FontSizeAlbum#
FontColor=#ColorAlbumName#
ClipString=1
DynamicVariables=1

; Progress Bar Background
[MeterProgressBarBG]
Meter=Shape
X=#ProgressBarX#
Y=#ProgressBarY#
Shape=Rectangle 0,0,#ProgressBarW#,#ProgressBarH#,3 | Fill Color #ColorProgressBarBG# | StrokeWidth 0

; Progress Bar Fill
[MeterProgressBar]
Meter=Shape
X=#ProgressBarX#
Y=#ProgressBarY#
Shape=Rectangle 0,0,(#ProgressBarW# * [MeasureProgressPercent] / 100),#ProgressBarH#,3 | Fill Color #ColorProgressBarFill# | StrokeWidth 0
DynamicVariables=1

; Progress Time Text
[MeterProgressTime]
Meter=String
MeasureName=MeasureProgressTime
X=#ProgressBarX#
Y=(#ProgressBarY# + 8)
FontFace=#FontFace#
FontSize=#FontSizeTime#
FontColor=#ColorTimeText#
NumOfDecimals=0
TimeStamp=%M:%S
DynamicVariables=1

; Duration Time Text
[MeterDurationTime]
Meter=String
MeasureName=MeasureDurationTime
X=(#ProgressBarX# + #ProgressBarW#)
Y=(#ProgressBarY# + 8)
FontFace=#FontFace#
FontSize=#FontSizeTime#
FontColor=#ColorTimeText#
StringAlign=Right
NumOfDecimals=0
TimeStamp=%M:%S
DynamicVariables=1

;==============================================================================
; METERS - PLAYBACK CONTROLS
;==============================================================================

; Previous Button
[MeterButtonPrevious]
Meter=Image
X=(#SkinWidth# / 2 - (#ControlButtonSize# * 3 + #ControlButtonSpacing# * 2) / 2)
Y=#ControlButtonsY#
W=#ControlButtonSize#
H=#ControlButtonSize#
ImageName=#@#Images\previous.png
LeftMouseUpAction=[!EnableMeasure MeasurePrevious][!SetOption MeasurePrevious Header "Authorization: Bearer #SpotifyAccessToken#"][!CommandMeasure MeasurePrevious "Update"][!DisableMeasure MeasurePrevious]
DynamicVariables=1

; Play/Pause Button
[MeterButtonPlayPause]
Meter=Image
X=#ControlButtonSpacing#R
Y=#ControlButtonsY#
W=#ControlButtonSize#
H=#ControlButtonSize#
ImageName=#@#Images\play.png
LeftMouseUpAction=[!EnableMeasure MeasurePlayPause][!SetOption MeasurePlayPause Header "Authorization: Bearer #SpotifyAccessToken#"][!CommandMeasure MeasurePlayPause "Update"][!DisableMeasure MeasurePlayPause]
DynamicVariables=1

; Next Button
[MeterButtonNext]
Meter=Image
X=#ControlButtonSpacing#R
Y=#ControlButtonsY#
W=#ControlButtonSize#
H=#ControlButtonSize#
ImageName=#@#Images\next.png
LeftMouseUpAction=[!EnableMeasure MeasureNext][!SetOption MeasureNext Header "Authorization: Bearer #SpotifyAccessToken#"][!CommandMeasure MeasureNext "Update"][!DisableMeasure MeasureNext]
DynamicVariables=1

;==============================================================================
; DEBUG METERS (Optional - comment out for production)
;==============================================================================

; Token Status
[MeterTokenStatus]
Meter=String
X=10
Y=10
FontFace=Consolas
FontSize=8
FontColor=100,100,100,255
Text=Token: [&MeasureTokenManager:GetStatus()] | Expires: [&MeasureTokenManager:GetTimeRemainingString()]
DynamicVariables=1

; Access Token (showing first part for verification)
[MeterDebugAccessToken]
Meter=String
X=10
Y=25
W=380
H=20
FontFace=Consolas
FontSize=7
FontColor=150,150,150,255
Text=AccessToken: #SpotifyAccessToken#
ClipString=2
ClipStringW=380
DynamicVariables=1

; API Response Status
[MeterDebugAPIStatus]
Meter=String
X=10
Y=40
FontFace=Consolas
FontSize=8
FontColor=200,200,100,255
Text=TrackName: [MeasureTrackName] | Artist: [MeasureArtistName]
DynamicVariables=1

; Is Playing Status
[MeterDebugIsPlaying]
Meter=String
X=10
Y=55
FontFace=Consolas
FontSize=8
FontColor=200,100,200,255
Text=IsPlaying: [MeasureIsPlaying] | Progress: [MeasureProgress]ms | Duration: [MeasureDuration]ms
DynamicVariables=1

; Album Art URL
[MeterDebugAlbumArtURL]
Meter=String
X=10
Y=70
FontFace=Consolas
FontSize=8
FontColor=100,200,200,255
Text=AlbumArtURL: [MeasureAlbumArtURL:~0,50]...
DynamicVariables=1

; WebParser Update Counter
[MeterDebugUpdateCount]
Meter=String
X=10
Y=85
FontFace=Consolas
FontSize=8
FontColor=200,150,100,255
Text=NowPlaying Updates: [MeasureNowPlayingData] | Last Update: [&MeasureNowPlayingData:Timestamp]
DynamicVariables=1
