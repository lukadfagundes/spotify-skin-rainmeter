;==============================================================================
; Spotify Now Playing - Rainmeter Skin
;==============================================================================
; A Rainmeter skin that displays currently playing track from Spotify using
; the Spotify Web API with OAuth 2.0 authentication.
;
; Requirements:
; - Valid Spotify account
; - Registered Spotify Developer App
; - OAuth credentials in @Vault\SpotifyCredentials.inc (run SpotifySetup.exe)
;
; Features:
; - Real-time track information (song, artist, album)
; - Album artwork with caching
; - Playback controls (play/pause, next, previous)
; - Progress bar with time display
; - Automatic token refresh (no manual intervention needed)
;
; Author: Spotify Rainmeter Skin Project
; Version: 1.0.0
; License: MIT
;==============================================================================

[Rainmeter]
Update=1000
BackgroundMode=2
SolidColor=0,0,0,200

;==============================================================================
; METADATA
;==============================================================================

[Metadata]
Name=Spotify Now Playing
Author=Spotify Rainmeter Skin Project
Version=1.0.0
License=MIT
Information=Displays currently playing Spotify track with playback controls

;==============================================================================
; VARIABLES
;==============================================================================

[Variables]
@Include=#SKINSPATH#@Vault\SpotifyCredentials.inc
@Include2=#@#Variables.inc

;==============================================================================
; MEASURES - TOKEN MANAGEMENT
;==============================================================================

; TokenManager Script - Handles automatic token refresh
[MeasureTokenManager]
Measure=Script
ScriptFile=#@#Scripts\TokenManager.lua
UpdateDivider=60
; Calls Initialize() on load, Update() every 60 seconds
OnUpdateAction=[!Log "TokenManager: Update() called, Status=[&MeasureTokenManager:GetStatus()], TimeRemaining=[&MeasureTokenManager:GetTimeRemainingString()]" Debug]

;------------------------------------------------------------------------------
; Authorization Header Builder
; Encodes client_id:client_secret in Base64 for Basic auth
;------------------------------------------------------------------------------

; Note: Rainmeter doesn't have built-in Base64 encoding, so this needs to be
; pre-computed or done via Lua script. This measure must run BEFORE MeasureTokenRefresh.

[MeasureAuthHeader]
Measure=Script
ScriptFile=#@#Scripts\Base64Encoder.lua
; This script will encode SpotifyClientID:SpotifyClientSecret and set AuthHeaderBase64 variable
FinishAction=[!Log "MeasureAuthHeader finished, AuthHeaderBase64=#AuthHeaderBase64#" Debug]
DynamicVariables=1

;------------------------------------------------------------------------------
; Token Refresh WebParser - Requests new access token using refresh token
;------------------------------------------------------------------------------

[MeasureTokenRefresh]
Measure=WebParser
; Spotify Token Endpoint
URL=https://accounts.spotify.com/api/token
; POST request with refresh_token grant
RequestMethod=POST
; Basic authentication: Base64(client_id:client_secret)
Header=Authorization: Basic #AuthHeaderBase64#
Header2=Content-Type: application/x-www-form-urlencoded
; Request body
PostData=grant_type=refresh_token&refresh_token=#SpotifyRefreshToken#
; Parse JSON response
RegExp=(?siU)"access_token"\s*:\s*"(.+?)".+"expires_in"\s*:\s*([0-9]+)..*("refresh_token"\s*:\s*"(.+?)")?
; Update only when triggered by TokenManager
UpdateRate=-1
DynamicVariables=1
Debug=0
; Log what we're sending
OnUpdateAction=[!Log "TokenRefresh: Base64=[#AuthHeaderBase64#]" Debug][!Log "TokenRefresh: RefreshToken=[#SpotifyRefreshToken#]" Debug]
; Callbacks
FinishAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshFinish()"]
OnConnectErrorAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshError('Connection failed')"]
OnRegExpErrorAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshError('Invalid response')"]
OnDownloadErrorAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshError('Download failed')"]

; Child measure - Access Token
[MeasureTokenRefreshAccessToken]
Measure=WebParser
URL=[MeasureTokenRefresh]
StringIndex=1
; Update skin variable for immediate use
FinishAction=[!SetVariable SpotifyAccessToken "[MeasureTokenRefreshAccessToken]"]

; Child measure - Expires In (seconds)
[MeasureTokenRefreshExpiresIn]
Measure=WebParser
URL=[MeasureTokenRefresh]
StringIndex=2

; Child measure - Refresh Token (optional - only returned if rotated)
[MeasureTokenRefreshRefreshToken]
Measure=WebParser
URL=[MeasureTokenRefresh]
StringIndex=4
; Update skin variable if present
FinishAction=[!SetVariable SpotifyRefreshToken "[&MeasureTokenRefreshRefreshToken:IfMatch(^$,0,1)]"]

;==============================================================================
; MEASURES - SPOTIFY API (Currently Playing)
;==============================================================================

; Currently Playing - Uses RunCommand to execute curl with dynamic Bearer token
; This approach works around WebParser's lack of DynamicVariables support for Headers
[MeasureNowPlayingData]
Measure=Plugin
Plugin=RunCommand
Program=curl
Parameter=-s -H "Authorization: Bearer #SpotifyAccessToken#" "https://api.spotify.com/v1/me/player/currently-playing"
OutputType=ANSI
State=Hide
DynamicVariables=1
FinishAction=[!UpdateMeasure MeasureNowPlayingParser][!Log "RunCommand finished" Debug]

; JSON Parser - Parses curl output and sets variables
[MeasureNowPlayingParser]
Measure=Script
ScriptFile=#@#Scripts\NowPlayingParser.lua
UpdateDivider=-1
DynamicVariables=1

; Trigger - Calls RunCommand every 5 seconds to fetch now playing data
[MeasureTrigger]
Measure=Calc
Formula=Counter % 5
IfEqualValue=0
IfEqualAction=[!Log "Trigger: Executing curl..." Debug][!CommandMeasure MeasureNowPlayingData "Run"]


;==============================================================================
; MEASURES - ALBUM ART DOWNLOAD
;==============================================================================

; Album Art Downloader - Downloads album art from Spotify CDN
[MeasureAlbumArt]
Measure=Plugin
Plugin=WebParser
URL=#AlbumArtURL#
Download=1
DynamicVariables=1
DownloadFile=current-album.jpg
UpdateRate=-1
OnDownloadFinishAction=[!UpdateMeter MeterAlbumArtContainer][!Redraw][!Log "Album art downloaded" Debug]
OnDownloadErrorAction=[!Log "Album art download failed: URL=#AlbumArtURL#" Error]

;==============================================================================
; MEASURES - PLAYBACK CONTROLS (using curl)
;==============================================================================

; Play Control - Resume playback
[MeasurePlay]
Measure=Plugin
Plugin=RunCommand
Program=curl
Parameter=-s -X PUT -H "Authorization: Bearer #SpotifyAccessToken#" -H "Content-Length: 0" "https://api.spotify.com/v1/me/player/play"
OutputType=UTF8
State=Hide
DynamicVariables=1
FinishAction=[!Log "Play command sent" Debug][!Delay 1000][!CommandMeasure MeasureNowPlayingData "Run"]

; Pause Control
[MeasurePause]
Measure=Plugin
Plugin=RunCommand
Program=curl
Parameter=-s -X PUT -H "Authorization: Bearer #SpotifyAccessToken#" -H "Content-Length: 0" "https://api.spotify.com/v1/me/player/pause"
OutputType=UTF8
State=Hide
DynamicVariables=1
FinishAction=[!Log "Pause command sent" Debug][!Delay 1000][!CommandMeasure MeasureNowPlayingData "Run"]

; Next Track Control
[MeasureNext]
Measure=Plugin
Plugin=RunCommand
Program=curl
Parameter=-s -X POST -H "Authorization: Bearer #SpotifyAccessToken#" -H "Content-Length: 0" "https://api.spotify.com/v1/me/player/next"
OutputType=UTF8
State=Hide
DynamicVariables=1
FinishAction=[!Log "Next command sent" Debug][!Delay 1000][!CommandMeasure MeasureNowPlayingData "Run"]

; Previous Track Control
[MeasurePrevious]
Measure=Plugin
Plugin=RunCommand
Program=curl
Parameter=-s -X POST -H "Authorization: Bearer #SpotifyAccessToken#" -H "Content-Length: 0" "https://api.spotify.com/v1/me/player/previous"
OutputType=UTF8
State=Hide
DynamicVariables=1
FinishAction=[!Log "Previous command sent" Debug][!Delay 1000][!CommandMeasure MeasureNowPlayingData "Run"]

;==============================================================================
; MEASURES - CALCULATED VALUES
;==============================================================================

; Progress Percentage (for progress bar)
[MeasureProgressPercent]
Measure=Calc
Formula=Clamp((#ProgressMs# / (#DurationMs# + 0.0001)) * 100, 0, 100)
MinValue=0
MaxValue=100
DynamicVariables=1

; Progress Time (formatted as MM:SS)
[MeasureProgressTime]
Measure=Calc
Formula=#ProgressMs# / 1000
DynamicVariables=1
TimeStamp=%M:%S

; Duration Time (formatted as MM:SS)
[MeasureDurationTime]
Measure=Calc
Formula=#DurationMs# / 1000
DynamicVariables=1
TimeStamp=%M:%S

;==============================================================================
; METERS - UI LAYOUT
;==============================================================================

; Background
[MeterBackground]
Meter=Shape
X=0
Y=0
Shape=Rectangle 0,0,#SkinWidth#,#SkinHeight#,#SkinCornerRadius# | Fill Color #ColorBackground# | StrokeWidth 2 | Stroke Color #ColorBorder#

; Album Art Container
[MeterAlbumArtContainer]
Meter=Image
MeasureName=MeasureAlbumArt
X=#AlbumArtX#
Y=#AlbumArtY#
W=#AlbumArtSize#
H=#AlbumArtSize#
PreserveAspectRatio=1
DynamicVariables=1

; Track Name
[MeterTrackName]
Meter=String
Text=#TrackName#
X=#TrackNameX#
Y=#TrackNameY#
W=#TrackNameW#
H=#TrackNameH#
FontFace=#FontFace#
FontSize=#FontSizeTrack#
FontWeight=#FontWeightTrack#
FontColor=#ColorTrackName#
ClipString=1
AntiAlias=1
DynamicVariables=1

; Artist Name
[MeterArtistName]
Meter=String
Text=#ArtistName#
X=#ArtistNameX#
Y=#ArtistNameY#
W=#ArtistNameW#
H=#ArtistNameH#
FontFace=#FontFace#
FontSize=#FontSizeArtist#
FontColor=#ColorArtistName#
ClipString=1
AntiAlias=1
DynamicVariables=1

; Album Name
[MeterAlbumName]
Meter=String
Text=#AlbumName#
X=#AlbumNameX#
Y=#AlbumNameY#
W=#AlbumNameW#
H=#AlbumNameH#
FontFace=#FontFace#
FontSize=#FontSizeAlbum#
FontColor=#ColorAlbumName#
ClipString=1
AntiAlias=1
DynamicVariables=1

; Progress Bar Background
[MeterProgressBarBG]
Meter=Shape
X=#ProgressBarX#
Y=#ProgressBarY#
Shape=Rectangle 0,0,#ProgressBarW#,#ProgressBarH#,3 | Fill Color #ColorProgressBarBG# | StrokeWidth 0

; Progress Bar Fill
[MeterProgressBar]
Meter=Shape
X=#ProgressBarX#
Y=#ProgressBarY#
Shape=Rectangle 0,0,(#ProgressBarW# * [MeasureProgressPercent] / 100),#ProgressBarH#,3 | Fill Color #ColorProgressBarFill# | StrokeWidth 0
DynamicVariables=1

; Progress Time Text
[MeterProgressTime]
Meter=String
Text=#ProgressTimeFormatted#
X=#ProgressBarX#
Y=(#ProgressBarY# + 8)
FontFace=#FontFace#
FontSize=#FontSizeTime#
FontColor=#ColorTimeText#
AntiAlias=1
DynamicVariables=1

; Duration Time Text
[MeterDurationTime]
Meter=String
Text=#DurationTimeFormatted#
X=(#ProgressBarX# + #ProgressBarW#)
Y=(#ProgressBarY# + 8)
FontFace=#FontFace#
FontSize=#FontSizeTime#
FontColor=#ColorTimeText#
StringAlign=Right
AntiAlias=1
DynamicVariables=1

;==============================================================================
; METERS - PLAYBACK CONTROLS
;==============================================================================

; Previous Button
[MeterButtonPrevious]
Meter=Image
X=(#SkinWidth# / 2 - (#ControlButtonSize# * 3 + #ControlButtonSpacing# * 2) / 2)
Y=#ControlButtonsY#
W=#ControlButtonSize#
H=#ControlButtonSize#
ImageName=#@#Images\previous.png
LeftMouseUpAction=[!CommandMeasure MeasurePrevious "Run"]
DynamicVariables=1

; Play Button - Shows when music is paused
[MeterButtonPlay]
Meter=Image
X=(#SkinWidth# / 2 - #ControlButtonSize# / 2)
Y=#ControlButtonsY#
W=#ControlButtonSize#
H=#ControlButtonSize#
ImageName=#@#Images\play.png
LeftMouseUpAction=[!CommandMeasure MeasurePlay "Run"]
Hidden=(#IsPlaying#)
DynamicVariables=1

; Pause Button - Shows when music is playing
[MeterButtonPause]
Meter=Image
X=(#SkinWidth# / 2 - #ControlButtonSize# / 2)
Y=#ControlButtonsY#
W=#ControlButtonSize#
H=#ControlButtonSize#
ImageName=#@#Images\pause.png
LeftMouseUpAction=[!CommandMeasure MeasurePause "Run"]
Hidden=(1-#IsPlaying#)
DynamicVariables=1

; Next Button
[MeterButtonNext]
Meter=Image
X=(#SkinWidth# / 2 + #ControlButtonSize# / 2 + #ControlButtonSpacing#)
Y=#ControlButtonsY#
W=#ControlButtonSize#
H=#ControlButtonSize#
ImageName=#@#Images\next.png
LeftMouseUpAction=[!CommandMeasure MeasureNext "Run"]
DynamicVariables=1

;==============================================================================
; DEBUG METERS (Optional - comment out for production)
;==============================================================================

; Token Status
[MeterTokenStatus]
Meter=String
X=10
Y=10
FontFace=Consolas
FontSize=8
FontColor=100,100,100,255
Text=Token: [&MeasureTokenManager:GetStatus()] | Expires: [&MeasureTokenManager:GetTimeRemainingString()]
DynamicVariables=1

; Access Token (showing first part for verification)
[MeterDebugAccessToken]
Meter=String
X=10
Y=25
W=380
H=20
FontFace=Consolas
FontSize=7
FontColor=150,150,150,255
Text=AccessToken: #SpotifyAccessToken#
ClipString=2
ClipStringW=380
DynamicVariables=1

; API Response Status
[MeterDebugAPIStatus]
Meter=String
X=10
Y=40
FontFace=Consolas
FontSize=8
FontColor=200,200,100,255
Text=Track: #TrackName# | Artist: #ArtistName#
DynamicVariables=1

; Progress Status
[MeterDebugProgress]
Meter=String
X=10
Y=55
FontFace=Consolas
FontSize=8
FontColor=200,100,200,255
Text=Progress: #ProgressMs#ms / #DurationMs#ms ([MeasureProgressPercent:0]%)
DynamicVariables=1

; Time Debug
[MeterDebugTime]
Meter=String
X=10
Y=85
FontFace=Consolas
FontSize=8
FontColor=200,100,100,255
Text=ProgressTime: #ProgressTimeFormatted# | DurationTime: #DurationTimeFormatted#
DynamicVariables=1
