;==============================================================================
; Spotify Now Playing - Rainmeter Skin
;==============================================================================
; A Rainmeter skin that displays currently playing track from Spotify using
; the Spotify Web API with OAuth 2.0 authentication.
;
; Requirements:
; - Valid Spotify account
; - Registered Spotify Developer App
; - OAuth credentials in @Vault\SpotifyCredentials.inc (run SpotifySetup.exe)
;
; Features:
; - Real-time track information (song, artist, album)
; - Album artwork with caching
; - Playback controls (play/pause, next, previous)
; - Progress bar with time display
; - Automatic token refresh (no manual intervention needed)
;
; Author: Spotify Rainmeter Skin Project
; Version: 1.0.0
; License: MIT
;==============================================================================

[Rainmeter]
Update=1000
BackgroundMode=2
SolidColor=0,0,0,200

;==============================================================================
; METADATA
;==============================================================================

[Metadata]
Name=Spotify Now Playing
Author=Spotify Rainmeter Skin Project
Version=1.0.0
License=MIT
Information=Displays currently playing Spotify track with playback controls

;==============================================================================
; VARIABLES
;==============================================================================

[Variables]
@Include=#@#..\..\@Vault\SpotifyCredentials.inc
@Include2=#@#Variables.inc

;==============================================================================
; MEASURES - TOKEN MANAGEMENT
;==============================================================================

; TokenManager Script - Handles automatic token refresh
[MeasureTokenManager]
Measure=Script
ScriptFile=#@#Scripts\TokenManager.lua
UpdateDivider=60
; Calls Initialize() on load, Update() every 60 seconds

;------------------------------------------------------------------------------
; Token Refresh WebParser - Requests new access token using refresh token
;------------------------------------------------------------------------------

[MeasureTokenRefresh]
Measure=WebParser
; Spotify Token Endpoint
URL=https://accounts.spotify.com/api/token
; POST request with refresh_token grant
RequestMethod=POST
; Basic authentication: Base64(client_id:client_secret)
Header=Authorization: Basic [MeasureAuthHeader]
Header2=Content-Type: application/x-www-form-urlencoded
; Request body
PostData=grant_type=refresh_token&refresh_token=#SpotifyRefreshToken#
; Parse JSON response
RegExp=(?siU)"access_token"\s*:\s*"(.+?)".+"expires_in"\s*:\s*([0-9]+).*("refresh_token"\s*:\s*"(.+?)")?
; Update only when triggered by TokenManager
UpdateRate=-1
DynamicVariables=1
; Callbacks
FinishAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshFinish()"]
OnConnectErrorAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshError('Connection failed')"]
OnRegExpErrorAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshError('Invalid response')"]
OnDownloadErrorAction=[!CommandMeasure MeasureTokenManager "OnTokenRefreshError('Download failed')"]

; Child measure - Access Token
[MeasureTokenRefreshAccessToken]
Measure=WebParser
URL=[MeasureTokenRefresh]
StringIndex=1
; Update skin variable for immediate use
FinishAction=[!SetVariable SpotifyAccessToken "[MeasureTokenRefreshAccessToken]"]

; Child measure - Expires In (seconds)
[MeasureTokenRefreshExpiresIn]
Measure=WebParser
URL=[MeasureTokenRefresh]
StringIndex=2

; Child measure - Refresh Token (optional - only returned if rotated)
[MeasureTokenRefreshRefreshToken]
Measure=WebParser
URL=[MeasureTokenRefresh]
StringIndex=4
; Update skin variable if present
FinishAction=[!SetVariable SpotifyRefreshToken "[&MeasureTokenRefreshRefreshToken:IfMatch(^$,0,1)]"]

;------------------------------------------------------------------------------
; Authorization Header Builder
; Encodes client_id:client_secret in Base64 for Basic auth
;------------------------------------------------------------------------------

; Note: Rainmeter doesn't have built-in Base64 encoding, so this needs to be
; pre-computed or done via Lua script. For simplicity, we'll create a helper measure.

[MeasureAuthHeader]
Measure=Script
ScriptFile=#@#Scripts\Base64Encoder.lua
UpdateDivider=-1
; This script will encode SpotifyClientID:SpotifyClientSecret

;==============================================================================
; MEASURES - SPOTIFY API (Currently Playing)
;==============================================================================

; Currently Playing WebParser - Fetches current playback state
[MeasureNowPlaying]
Measure=WebParser
; Spotify Currently Playing endpoint (works with our OAuth scopes)
URL=https://api.spotify.com/v1/me/player/currently-playing
; GET request with Bearer token authentication
Header=Authorization: Bearer #SpotifyAccessToken#
; RegExp pattern matched to actual Spotify API response
; StringIndex: 1=track_name, 2=artist_name, 3=album_name, 4=album_art_url, 5=duration_ms, 6=progress_ms, 7=is_playing
RegExp=(?siU)"item".*"name":"([^"]+)".*"artists".*"name":"([^"]+)".*"album".*"name":"([^"]+)".*"images".*"url":"([^"]+)".*"duration_ms":([0-9]+).*"progress_ms":([0-9]+).*"is_playing":(true|false)
; Update every 5 seconds
UpdateRate=5
; Required for #SpotifyAccessToken# variable substitution
DynamicVariables=1
; Error handling with detailed logging
OnConnectErrorAction=[!Log "API Connect Error: Cannot reach Spotify API" Error][!SetOption MeterTrackName Text "Not Playing"][!UpdateMeter MeterTrackName][!Redraw]
OnRegExpErrorAction=[!Log "API RegExp Error: Response doesn't match pattern" Error][!SetOption MeterTrackName Text "No Track Info"][!UpdateMeter MeterTrackName][!Redraw]
OnDownloadErrorAction=[!Log "API Download Error: HTTP error from Spotify" Error][!SetOption MeterTrackName Text "API Error"][!UpdateMeter MeterTrackName][!Redraw]
FinishAction=[!Log "API Success: Data received from Spotify" Notice]

; Child measure - Track Name
[MeasureTrackName]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=1
Substitute="&quot;":"\"","&amp;":"&"

; Child measure - Artist Name
[MeasureArtistName]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=2
Substitute="&quot;":"\"","&amp;":"&"

; Child measure - Album Name
[MeasureAlbumName]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=3
Substitute="&quot;":"\"","&amp;":"&"

; Child measure - Album Art URL
[MeasureAlbumArtURL]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=4

; Child measure - Duration (milliseconds)
[MeasureDuration]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=5

; Child measure - Progress (milliseconds)
[MeasureProgress]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=6

; Child measure - Is Playing (true/false)
[MeasureIsPlaying]
Measure=WebParser
URL=[MeasureNowPlaying]
StringIndex=7

;==============================================================================
; MEASURES - ALBUM ART DOWNLOAD
;==============================================================================

; Album Art Downloader
[MeasureAlbumArt]
Measure=Plugin
Plugin=WebParser
URL=[MeasureAlbumArtURL]
Download=1
; Cache album art in @Resources\Cache\
DownloadFile=#@#Cache\[MeasureAlbumArtURL:EncodeURL].jpg
UpdateRate=10
; Only download if URL changed
IfMatch=^$
IfNotMatchAction=[!SetOption MeterAlbumArt ImageName "#@#Images\default-album.png"]

;==============================================================================
; MEASURES - PLAYBACK CONTROLS
;==============================================================================

; Play/Resume Control
[MeasurePlayPause]
Measure=WebParser
URL=https://api.spotify.com/v1/me/player/play
RequestMethod=PUT
Header=Authorization: Bearer #SpotifyAccessToken#
UpdateRate=-1
DynamicVariables=1

; Pause Control
[MeasurePause]
Measure=WebParser
URL=https://api.spotify.com/v1/me/player/pause
RequestMethod=PUT
Header=Authorization: Bearer #SpotifyAccessToken#
UpdateRate=-1
DynamicVariables=1

; Next Track Control
[MeasureNext]
Measure=WebParser
URL=https://api.spotify.com/v1/me/player/next
RequestMethod=POST
Header=Authorization: Bearer #SpotifyAccessToken#
UpdateRate=-1
DynamicVariables=1
FinishAction=[!Delay 500][!CommandMeasure MeasureNowPlaying "Update"]

; Previous Track Control
[MeasurePrevious]
Measure=WebParser
URL=https://api.spotify.com/v1/me/player/previous
RequestMethod=POST
Header=Authorization: Bearer #SpotifyAccessToken#
UpdateRate=-1
DynamicVariables=1
FinishAction=[!Delay 500][!CommandMeasure MeasureNowPlaying "Update"]

;==============================================================================
; MEASURES - CALCULATED VALUES
;==============================================================================

; Progress Percentage (for progress bar)
[MeasureProgressPercent]
Measure=Calc
Formula=(MeasureProgress / MeasureDuration) * 100
MinValue=0
MaxValue=100

; Progress Time (formatted as MM:SS)
[MeasureProgressTime]
Measure=Calc
Formula=MeasureProgress / 1000
DynamicVariables=1

; Duration Time (formatted as MM:SS)
[MeasureDurationTime]
Measure=Calc
Formula=MeasureDuration / 1000
DynamicVariables=1

;==============================================================================
; METERS - UI LAYOUT
;==============================================================================

; Background
[MeterBackground]
Meter=Shape
X=0
Y=0
Shape=Rectangle 0,0,#SkinWidth#,#SkinHeight#,#SkinCornerRadius# | Fill Color #ColorBackground# | StrokeWidth 2 | Stroke Color #ColorBorder#

; Album Art Container
[MeterAlbumArtContainer]
Meter=Image
X=#AlbumArtX#
Y=#AlbumArtY#
W=#AlbumArtSize#
H=#AlbumArtSize#
ImageName=#@#Cache\current-album.jpg
PreserveAspectRatio=1
DynamicVariables=1

; Track Name
[MeterTrackName]
Meter=String
MeasureName=MeasureTrackName
X=#TrackNameX#
Y=#TrackNameY#
W=#TrackNameW#
H=#TrackNameH#
FontFace=#FontFace#
FontSize=#FontSizeTrack#
FontWeight=#FontWeightTrack#
FontColor=#ColorTrackName#
ClipString=1
DynamicVariables=1
Text=%1

; Artist Name
[MeterArtistName]
Meter=String
MeasureName=MeasureArtistName
X=#ArtistNameX#
Y=#ArtistNameY#
W=#ArtistNameW#
H=#ArtistNameH#
FontFace=#FontFace#
FontSize=#FontSizeArtist#
FontColor=#ColorArtistName#
ClipString=1
DynamicVariables=1
Text=%1

; Album Name
[MeterAlbumName]
Meter=String
MeasureName=MeasureAlbumName
X=#AlbumNameX#
Y=#AlbumNameY#
W=#AlbumNameW#
H=#AlbumNameH#
FontFace=#FontFace#
FontSize=#FontSizeAlbum#
FontColor=#ColorAlbumName#
ClipString=1
DynamicVariables=1
Text=%1

; Progress Bar Background
[MeterProgressBarBG]
Meter=Shape
X=#ProgressBarX#
Y=#ProgressBarY#
Shape=Rectangle 0,0,#ProgressBarW#,#ProgressBarH#,3 | Fill Color #ColorProgressBarBG# | StrokeWidth 0

; Progress Bar Fill
[MeterProgressBar]
Meter=Shape
X=#ProgressBarX#
Y=#ProgressBarY#
Shape=Rectangle 0,0,(#ProgressBarW# * [MeasureProgressPercent] / 100),#ProgressBarH#,3 | Fill Color #ColorProgressBarFill# | StrokeWidth 0
DynamicVariables=1

; Progress Time Text
[MeterProgressTime]
Meter=String
MeasureName=MeasureProgressTime
X=#ProgressBarX#
Y=(#ProgressBarY# + 8)
FontFace=#FontFace#
FontSize=#FontSizeTime#
FontColor=#ColorTimeText#
NumOfDecimals=0
AutoScale=1
Text=[MeasureProgressTime:FormatTime("%M:%S")]
DynamicVariables=1

; Duration Time Text
[MeterDurationTime]
Meter=String
MeasureName=MeasureDurationTime
X=(#ProgressBarX# + #ProgressBarW#)
Y=(#ProgressBarY# + 8)
FontFace=#FontFace#
FontSize=#FontSizeTime#
FontColor=#ColorTimeText#
StringAlign=Right
NumOfDecimals=0
AutoScale=1
Text=[MeasureDurationTime:FormatTime("%M:%S")]
DynamicVariables=1

;==============================================================================
; METERS - PLAYBACK CONTROLS
;==============================================================================

; Previous Button
[MeterButtonPrevious]
Meter=Image
X=(#SkinWidth# / 2 - (#ControlButtonSize# * 3 + #ControlButtonSpacing# * 2) / 2)
Y=#ControlButtonsY#
W=#ControlButtonSize#
H=#ControlButtonSize#
ImageName=#@#Images\previous.png
LeftMouseUpAction=[!CommandMeasure MeasurePrevious "Update"]
DynamicVariables=1

; Play/Pause Button
[MeterButtonPlayPause]
Meter=Image
X=#ControlButtonSpacing#R
Y=#ControlButtonsY#
W=#ControlButtonSize#
H=#ControlButtonSize#
ImageName=#@#Images\play.png
LeftMouseUpAction=[!CommandMeasure MeasurePlayPause "Update"]
DynamicVariables=1

; Next Button
[MeterButtonNext]
Meter=Image
X=#ControlButtonSpacing#R
Y=#ControlButtonsY#
W=#ControlButtonSize#
H=#ControlButtonSize#
ImageName=#@#Images\next.png
LeftMouseUpAction=[!CommandMeasure MeasureNext "Update"]
DynamicVariables=1

;==============================================================================
; DEBUG METERS (Optional - comment out for production)
;==============================================================================

; Token Status
[MeterTokenStatus]
Meter=String
X=10
Y=10
FontFace=Consolas
FontSize=8
FontColor=100,100,100,255
Text=Token: [&MeasureTokenManager:GetStatus()] | Expires: [&MeasureTokenManager:GetTimeRemainingString()]
DynamicVariables=1

; Access Token (showing first part for verification)
[MeterDebugAccessToken]
Meter=String
X=10
Y=25
W=380
H=20
FontFace=Consolas
FontSize=7
FontColor=150,150,150,255
Text=AccessToken: #SpotifyAccessToken#
ClipString=2
ClipStringW=380
DynamicVariables=1

; API Response Status
[MeterDebugAPIStatus]
Meter=String
X=10
Y=40
FontFace=Consolas
FontSize=8
FontColor=200,200,100,255
Text=TrackName: [MeasureTrackName] | Artist: [MeasureArtistName]
DynamicVariables=1

; Is Playing Status
[MeterDebugIsPlaying]
Meter=String
X=10
Y=55
FontFace=Consolas
FontSize=8
FontColor=200,100,200,255
Text=IsPlaying: [MeasureIsPlaying] | Progress: [MeasureProgress]ms | Duration: [MeasureDuration]ms
DynamicVariables=1

; Album Art URL
[MeterDebugAlbumArtURL]
Meter=String
X=10
Y=70
FontFace=Consolas
FontSize=8
FontColor=100,200,200,255
Text=AlbumArtURL: [MeasureAlbumArtURL:~0,50]...
DynamicVariables=1

; WebParser Update Counter
[MeterDebugUpdateCount]
Meter=String
X=10
Y=85
FontFace=Consolas
FontSize=8
FontColor=200,150,100,255
Text=NowPlaying Updates: [MeasureNowPlaying] | Last Update: [&MeasureNowPlaying:Timestamp]
DynamicVariables=1
